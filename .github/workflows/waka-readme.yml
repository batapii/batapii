name: Update WakaTime Statistics

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update-stats:
    name: Update Stats
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0
          
      - name: Clean Git Config
        run: |
          rm -f .git/config
          git config --local --unset-all http.https://github.com/.extraheader || true
          git config --local --unset-all credential.helper || true
          
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global credential.helper store
          echo "https://x-access-token:${{ secrets.GH_TOKEN }}@github.com" > ~/.git-credentials
          
      - name: Clean Working Directory
        run: |
          git reset --hard HEAD
          git clean -fd
          
      - name: Check README
        run: |
          echo "Current README content:"
          cat README.md || echo "README.md not found"
          
      - name: Update WakaTime Stats
        uses: anmol098/waka-readme-stats@master
        with:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          SECTION_NAME: "waka"
          SHOW_LINES_OF_CODE: "True"
          SHOW_PROFILE_VIEWS: "True"
          SHOW_SHORT_INFO: "True"
          SHOW_TOTAL_CODE_TIME: "True"
          SHOW_LANGUAGE: "True"
          SHOW_DAYS_OF_WEEK: "True"
          SHOW_TIMEZONE: "True"
          SHOW_EDITORS: "True"
          SHOW_PROJECTS: "True"
          SHOW_OS: "True"
          COMMIT_BY_ME: "False"
          DEBUG_LOGGING: "True"
          
      - name: Verify Changes
        run: |
          echo "Modified files:"
          git status
          
          echo "Changes in README:"
          git diff README.md
          
      - name: Commit and Push
        run: |
          git add README.md
          git status
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            echo "Committing changes..."
            git commit -m "Updated WakaTime Statistics"
            
            echo "Setting up remote..."
            git remote set-url origin "https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git"
            
            echo "Pushing changes..."
            git push origin HEAD:main
          fi
