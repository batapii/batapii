name: Update README with WakaTime Stats

on:
  schedule:
    - cron: '0 0 * * *'  # 毎日 UTC 0:00 (JST 9:00) に実行
  workflow_dispatch:  # 手動実行のオプション

jobs:
  update-readme:
    name: Update README with WakaTime Metrics
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Update WakaTime stats
        uses: anmol098/waka-readme-stats@master
        with:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          SHOW_OS: "True"
          SHOW_PROJECTS: "True"
          SHOW_EDITORS: "True"
          SHOW_TIMEZONE: "False"
          SHOW_LOC_CHART: "False"
          SHOW_LINES_OF_CODE: "True"
          SHOW_PROFILE_VIEWS: "True"
          SHOW_COMMIT: "True"
          SHOW_DAYS_OF_WEEK: "True"
          SHOW_LANGUAGE: "True"
          SHOW_TOTAL_CODE_TIME: "True"
          SECTIONS_ORDER: "waka-commit-time,waka-week-stats,waka-time-stats,waka-editors,waka-projects,waka-os,waka-tech-stack"
          COMMIT_BY_ME: "True"
          COMMIT_MESSAGE: "Update README with WakaTime stats"

      - name: Update GitHub Data
        run: |
          # GitHub APIを使用してデータを取得し、github-data.mdに書き込む
          token="${{ secrets.GH_TOKEN }}"
          username="${{ github.repository_owner }}"
          api_url="https://api.github.com/users/$username"
          
          response=$(curl -s -H "Authorization: token $token" $api_url)
          public_repos=$(echo $response | jq '.public_repos')
          followers=$(echo $response | jq '.followers')
          
          echo "<!--START_SECTION:github-data-->" > github-data.md
          echo "<ul>" >> github-data.md
          echo "<li>📦 $(du -sh .git | cut -f1) Used in GitHub's Storage</li>" >> github-data.md
          echo "<li>🏆 $(git rev-list --count HEAD) Contributions in the Year $(date +%Y)</li>" >> github-data.md
          echo "<li>📜 $public_repos Public Repositories</li>" >> github-data.md
          echo "<li>🔑 $(ls -l ~/.ssh | grep -v "total" | wc -l) SSH Keys</li>" >> github-data.md
          echo "</ul>" >> github-data.md
          echo "<!--END_SECTION:github-data-->" >> github-data.md

      - name: Commit and push if changed
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add README.md github-data.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update README with WakaTime stats" && git push)
